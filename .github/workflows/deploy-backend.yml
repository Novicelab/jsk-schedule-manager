name: Deploy Backend to Render

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Render service
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          curl -X POST https://api.render.com/v1/services \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "web_service",
              "name": "jsk-schedule-backend",
              "ownerId": "tea-d6bf2th5pdvs73f5vkd0",
              "repo": "https://github.com/Novicelab/jsk-schedule-manager",
              "branch": "main",
              "rootDir": "backend",
              "buildCommand": "npm install",
              "startCommand": "npm start",
              "plan": "free",
              "region": "singapore",
              "serviceDetails": {
                "runtime": "node",
                "envSpecificDetails": {
                  "nodeVersion": "18"
                }
              },
              "envVars": [
                {"key": "NODE_ENV", "value": "production"},
                {"key": "PORT", "value": "3001"},
                {"key": "SUPABASE_URL", "value": "https://qphhpfolrbsyiyoevaoe.supabase.co"},
                {"key": "SUPABASE_SERVICE_ROLE_KEY", "value": "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"},
                {"key": "ALLOWED_ORIGINS", "value": "https://jsk-schedule-frontend.onrender.com"}
              ]
            }'
